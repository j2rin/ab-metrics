# IAC Mertics Description: https://docs.google.com/spreadsheets/d/1te22Wy-GVOW7VR4sTDmrRYb6x4SniWAcYfeZPWOmkhM

definitions:
  # Screens
  - &item_scenarios       [item, item_gallery]
  - &serp_scenarios       [item_feed, item_feed_photo]
  - &messenger_scenarios  [messenger_chat_menu, mini_messenger_chat_menu, seller_messenger_chat, deeplink_call_back, answering_machine_callback]
  - &call_scenarios       [call_screen, recall_after_micaccess, recall_on_call_screen]
  - &pro_scenarios        [pro_callback, pro_mini_messenger_chat_menu, pro_messenger_chat_menu]
  - &redirect_scenarios   [web_redirect]
  - &other_scenarios      [call_log_callback, notification_call_back]


  # Logical Groups
  - &callback_scenario    [deeplink_call_back, answering_machine_callback, call_screen, recall_after_micaccess, recall_on_call_screen, pro_callback, call_log_callback, notification_call_back]
  - &direct_scenario      [item, item_gallery, item_feed, item_feed_photo, messenger_chat_menu, mini_messenger_chat_menu, seller_messenger_chat, pro_mini_messenger_chat_menu, pro_messenger_chat_menu, web_redirect]
  - &any_scenario         [item, item_gallery, item_feed, item_feed_photo, messenger_chat_menu, mini_messenger_chat_menu, seller_messenger_chat, deeplink_call_back, answering_machine_callback, call_screen, recall_after_micaccess, recall_on_call_screen, pro_callback, pro_mini_messenger_chat_menu, pro_messenger_chat_menu, call_log_callback, notification_call_back, web_redirect]


  # Filters
  - &is_item_c            {AppCallScenario: *item_scenarios}
  - &is_serp_c            {AppCallScenario: *serp_scenarios}
  - &is_messenger_c       {AppCallScenario: *messenger_scenarios}
  - &is_call_c            {AppCallScenario: *call_scenarios}
  - &is_pro_c             {AppCallScenario: *pro_scenarios}
  - &is_redirect_c        {AppCallScenario: *redirect_scenarios}
  - &is_other_c           {AppCallScenario: *other_scenarios}

  - &is_callback_c        {AppCallScenario: *callback_scenario}
  - &is_direct_c          {AppCallScenario: *direct_scenario}
  - &is_c                 {AppCallScenario: *any_scenario}

  - &is_outgoing          {CallType: outgoing}
  - &is_incoming          {CallType: incoming}
  - &is_answered          {TalkDuration.>: 0}
  - &is_success           {TalkDuration.>: 30}
  - &is_zero              {TalkDuration.=: 0}
  

  # Auxiliary filters (TBC)
  - &is_initiated       {$or: [{is_receiver_init: True}, {is_receiver_ringing: True}, {TalkDuration.>: 0}]}
  - &is_ringing         {$or: [{is_receiver_ringing: True}, {TalkDuration.>: 0}]}
  - &mic_granted        {Reciever_MicAccess: True}
  - &mic_notgranted     {Reciever_MicAccess: False}
  - &mic_checked        {Reciever_MicAccess.isnull: False}




metric.counter:

  # Essential
  appcall_sx_any_calls:                         {filter: [*is_c]}
  appcall_sx_any_answered:                      {filter: [*is_c, *is_answered]}
  appcall_sx_any_talkseconds:                   {filter: [*is_c, *is_answered], obs: [TalkDuration]}

  appcall_sx_incoming:                          {filter: [*is_incoming, *is_c]}
  appcall_sx_incoming_answered:                 {filter: [*is_incoming, *is_c, *is_answered]}
  appcall_sx_incoming_talkseconds:              {filter: [*is_incoming, *is_c, *is_answered], obs: [TalkDuration]}

  appcall_sx_outgoing:                          {filter: [*is_outgoing, *is_c]}
  appcall_sx_outgoing_answered:                 {filter: [*is_outgoing, *is_c, *is_answered]}
  appcall_sx_outgoing_talkseconds:              {filter: [*is_outgoing, *is_c, *is_answered], obs: [TalkDuration]}
  
  # By logical group
  appcall_sx_outgoing_callback:                 {filter: [*is_outgoing, *is_callback_c]}
  appcall_sx_outgoing_callback_answered:        {filter: [*is_outgoing, *is_callback_c, *is_answered]}
  appcall_sx_outgoing_callback_talkseconds:     {filter: [*is_outgoing, *is_callback_c, *is_answered], obs: [TalkDuration]}

  appcall_sx_incoming_callback:                 {filter: [*is_incoming, *is_callback_c]}
  appcall_sx_incoming_callback_answered:        {filter: [*is_incoming, *is_callback_c, *is_answered]}
  appcall_sx_incoming_callback_talkseconds:     {filter: [*is_incoming, *is_callback_c, *is_answered], obs: [TalkDuration]}

  appcall_sx_outgoing_direct:                   {filter: [*is_outgoing, *is_direct_c]}
  appcall_sx_outgoing_direct_answered:          {filter: [*is_outgoing, *is_direct_c, *is_answered]}
  appcall_sx_outgoing_direct_talkseconds:       {filter: [*is_outgoing, *is_direct_c, *is_answered], obs: [TalkDuration]}

  appcall_sx_incoming_direct:                   {filter: [*is_incoming, *is_direct_c]}
  appcall_sx_incoming_direct_answered:          {filter: [*is_incoming, *is_direct_c, *is_answered]}
  appcall_sx_incoming_direct_talkseconds:       {filter: [*is_incoming, *is_direct_c, *is_answered], obs: [TalkDuration]}

  # By screen
  appcall_sx_incoming_item:                     {filter: [*is_incoming, *is_item_c]}
  appcall_sx_incoming_item_answered:            {filter: [*is_incoming, *is_item_c, *is_answered]}
  appcall_sx_incoming_item_talkseconds:         {filter: [*is_incoming, *is_item_c], obs: [TalkDuration]}

  appcall_sx_incoming_messenger:                {filter: [*is_incoming, *is_messenger_c]}
  appcall_sx_incoming_messenger_answered:       {filter: [*is_incoming, *is_messenger_c, *is_answered]}
  appcall_sx_incoming_messenger_talkseconds:    {filter: [*is_incoming, *is_messenger_c], obs: [TalkDuration]}

  appcall_sx_outgoing_pro:                      {filter: [*is_outgoing, *is_pro_c]}
  appcall_sx_outgoing_pro_answered:             {filter: [*is_outgoing, *is_pro_c, *is_answered]}
  appcall_sx_outgoing_pro_talkseconds:          {filter: [*is_outgoing, *is_pro_c], obs: [TalkDuration]}

  # Auxiliary
  appcall_sx_incoming_initiated:                {filter: [*is_incoming, *is_c, *is_initiated]}
  appcall_sx_incoming_ringing:                  {filter: [*is_incoming, *is_c, *is_ringing]}
  appcall_sx_incoming_direct_mic_granted:       {filter: [*is_incoming, *is_direct_c, *mic_granted]}
  appcall_sx_incoming_direct_mic_checked:       {filter: [*is_incoming, *is_direct_c, *mic_checked]}
  appcall_sx_outgoing_callback_initiated:       {filter: [*is_outgoing, *is_callback_c, *is_initiated]}
  appcall_sx_outgoing_callback_ringing:         {filter: [*is_outgoing, *is_callback_c, *is_ringing]}
  appcall_sx_incoming_callback_initiated:       {filter: [*is_incoming, *is_callback_c, *is_initiated]}
  appcall_sx_incoming_callback_ringing:         {filter: [*is_incoming, *is_callback_c, *is_ringing]}
  appcall_sx_incoming_direct_initiated:         {filter: [*is_incoming, *is_direct_c, *is_initiated]}
  appcall_sx_incoming_direct_ringing:           {filter: [*is_incoming, *is_direct_c, *is_ringing]}

  appcall_sx_outgoing_success:                  {filter: [*is_outgoing, *is_c, *is_success]}
  appcall_sx_incoming_success:                  {filter: [*is_incoming, *is_c, *is_success]}
  appcall_sx_incoming_direct_success:      {filter: [*is_incoming, *is_direct_c, *is_success]}
  appcall_sx_any_success:                       {filter: [*is_c, *is_success]}



metric.uniq:
  appcall_sx_any_canonical:                 {counter: appcall_sx_any_calls, key: [user, item]}



metric.ratio:
  appcall_sx_outgoing_talkseconds_avg:                  {num: appcall_sx_outgoing_talkseconds, den: appcall_sx_outgoing_answered}
  appcall_sx_incoming_talkseconds_avg:                  {num: appcall_sx_incoming_talkseconds, den: appcall_sx_incoming_answered}
  appcall_sx_any_talkseconds_avg:                       {num: appcall_sx_any_talkseconds, den: appcall_sx_any_answered}
  appcall_sx_incoming_direct_initiated_ratio:           {num: appcall_sx_incoming_direct_initiated, den: appcall_sx_incoming_direct}
  appcall_sx_incoming_direct_ringing_ratio:             {num: appcall_sx_incoming_direct_ringing, den: appcall_sx_incoming_direct}
  appcall_sx_incoming_direct_answered_ratio:            {num: appcall_sx_incoming_direct_answered, den: appcall_sx_incoming_direct}
  appcall_sx_incoming_direct_initiated_ringing_ratio:   {num: appcall_sx_incoming_direct_ringing, den: appcall_sx_incoming_direct_initiated}
  appcall_sx_incoming_direct_ringing_answered_ratio:    {num: appcall_sx_incoming_direct_answered, den: appcall_sx_incoming_direct_ringing}
  appcall_sx_incoming_direct_mic_granted_ratio:         {num: appcall_sx_incoming_direct_mic_granted, den: appcall_sx_incoming_direct_mic_checked}

  appcall_sx_incoming_direct_success_ratio:             {num: appcall_sx_incoming_direct_success, den: appcall_sx_incoming_direct}
  appcall_sx_incoming_direct_answered_success_ratio:    {num: appcall_sx_incoming_direct_success, den: appcall_sx_incoming_direct_answered}